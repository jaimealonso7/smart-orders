AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Hito 7 - Step Functions "procesar pedido" (validar -> pagar -> notificar)
Globals:
  Function:
    Runtime: nodejs20.x
    Handler: index.handler
    Timeout: 10
    MemorySize: 128
Resources:
  ValidateStockFn:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ValidateStockFn
      Description: Valida y reserva stock (simulado)
    Metadata:
      SamResourceId: ValidateStockFn
  ChargePaymentFn:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ChargePaymentFn
      Description: Marca como pagado (simulado)
    Metadata:
      SamResourceId: ChargePaymentFn
  ReleaseStockFn:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ReleaseStockFn
      Description: Revierte reserva de stock si falla pago
    Metadata:
      SamResourceId: ReleaseStockFn
  NotifyCustomerFn:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: NotifyCustomerFn
      Description: Notifica al cliente (stub; SNS se agrega en Hito 9)
    Metadata:
      SamResourceId: NotifyCustomerFn
  ProcessOrderStateMachine:
    Type: AWS::Serverless::StateMachine
    Properties:
      Name: procesar-pedido-hito7
      DefinitionUri: ..\..\statemachine\procesar-pedido.asl.json
      DefinitionSubstitutions:
        ValidateStockFnArn:
          Fn::GetAtt:
          - ValidateStockFn
          - Arn
        ChargePaymentFnArn:
          Fn::GetAtt:
          - ChargePaymentFn
          - Arn
        ReleaseStockFnArn:
          Fn::GetAtt:
          - ReleaseStockFn
          - Arn
        NotifyCustomerFnArn:
          Fn::GetAtt:
          - NotifyCustomerFn
          - Arn
      Policies:
      - LambdaInvokePolicy:
          FunctionName:
            Ref: ValidateStockFn
      - LambdaInvokePolicy:
          FunctionName:
            Ref: ChargePaymentFn
      - LambdaInvokePolicy:
          FunctionName:
            Ref: ReleaseStockFn
      - LambdaInvokePolicy:
          FunctionName:
            Ref: NotifyCustomerFn
Outputs:
  StateMachineArn:
    Description: ARN de la state machine
    Value:
      Ref: ProcessOrderStateMachine
